<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4 Mermaid Architecture Test & Wiki Render Harness</title>
    <!-- Libraries: Mermaid, Marked, DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 40px;
            background-color: #f5f5f5;
        }
        .diagram-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        h1, h2 {
            color: #333;
        }
        .mermaid {
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>🧜‍♀️ Phase 4 Mermaid Architecture Test</h1>
    <p>This page demonstrates Mermaid rendering and also acts as a standalone harness to fetch and render GitHub Wiki Markdown (Marked + DOMPurify + Mermaid).</p>

    <div class="diagram-container" style="border-left: 4px solid #0d6efd;">
        <h2>0. Wiki Render Harness</h2>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
            <label for="wikiPath" style="font-weight:600;">Wiki Path (.md):</label>
            <input id="wikiPath" type="text" value="Home.md" style="flex:1; min-width:260px; padding:8px;" />
            <button id="loadBtn" style="padding:8px 12px;">Load</button>
            <span id="status" style="color:#666; font-size:0.9rem;"></span>
        </div>
        <div id="wikiOutput" class="wiki-output" style="min-height:120px;"></div>
    </div>

    <div class="diagram-container">
        <h2>1. System Architecture Overview</h2>
        <div class="mermaid">
graph TB
    subgraph "Audio Input Sources"
        IM["🎤 Internal Mic<br/>(Raw/Calibrated)"]
        EM["🎙️ External Mic<br/>(Raw/Calibrated)"]
        LI["🔌 Audio Line Input<br/>(Analog)"]
        USB["🎛️ USB Interface<br/>(Professional)"]
    end
    
    subgraph "AudioInputManager"
        DS["🔍 Detection System<br/>• Device Enumeration<br/>• Classification<br/>• Capabilities"]
        CE["⚙️ Calibration Engine<br/>• Frequency Response<br/>• Sensitivity<br/>• Noise Floor"]
        SP["📡 Stream Processing<br/>• Low Latency<br/>• High Quality<br/>• Multi-Channel"]
    end
    
    subgraph "Triple-Path Analysis"
        REF["📊 Reference Path<br/>(Digital)"]
        SIM["🔄 Simulation Path<br/>(Processed)"]
        REAL["🌍 Reality Path<br/>(Measured)"]
    end
    
    IM --> DS
    EM --> DS
    LI --> DS
    USB --> DS
    
    DS --> CE
    CE --> SP
    
    SP --> REF
    SP --> SIM
    SP --> REAL
    
    style IM fill:#e1f5fe
    style EM fill:#e1f5fe
    style LI fill:#e8f5e8
    style USB fill:#fff3e0
    style REF fill:#f3e5f5
    style SIM fill:#e8f5e8
    style REAL fill:#fff8e1
        </div>
    </div>

    <div class="diagram-container">
        <h2>2. Signal Flow Architecture</h2>
        <div class="mermaid">
flowchart TD
    subgraph "Input Sources"
        REF2["📊 Reference Signals<br/>(Digital)"]
        MIC["🎤 Microphone Input<br/>(Analog)"]
        USB2["🎛️ USB Interface<br/>(Professional)"]
    end
    
    subgraph "Processing Layer"
        subgraph "Speaker Processing"
            DN["🔄 DelayNode Chain<br/>• A_left<br/>• A_right<br/>• B_left<br/>• B_right"]
            CF["🌊 Comb Filter<br/>• Dry Path<br/>• Wet Path"]
            DN --> CF
        end
        
        subgraph "Input Processing"
            CAL["⚙️ Calibration<br/>• Freq Correction<br/>• Sensitivity<br/>• Noise Filter"]
        end
    end
    
    subgraph "Analysis Engine"
        AR["📈 analyzers.reference<br/>(Raw Digital)"]
        AI["📊 analyzers.input<br/>(Processed Digital)"]
        AC["🎯 analyzers.calibrated<br/>(Real Measurement)"]
    end
    
    subgraph "Educational Output"
        TVR["🤔 Theory vs Reality"]
        SV["✅ Simulation Validation"]
        RC["🏠 Room Characterization"]
        PM["📊 Professional Metrics"]
    end
    
    REF2 --> DN
    MIC --> CAL
    USB2 --> CAL
    
    REF2 --> AR
    CF --> AI
    CAL --> AC
    
    AR --> TVR
    AI --> SV
    AC --> RC
    
    TVR --> PM
    SV --> PM
    RC --> PM
    
    style REF2 fill:#e3f2fd
    style MIC fill:#f3e5f5
    style USB2 fill:#fff3e0
    style DN fill:#e8f5e8
    style CF fill:#e8f5e8
    style CAL fill:#fff8e1
    style AR fill:#e1f5fe
    style AI fill:#e8f5e8
    style AC fill:#fff3e0
        </div>
    </div>

    <div class="diagram-container">
        <h2>3. Performance Metrics</h2>
        <div class="mermaid">
graph TB
    subgraph "Performance Metrics Dashboard"
        subgraph "Audio Quality"
            AQ1["⚡ Latency < 50ms"]
            AQ2["📡 SNR > 60dB"]
            AQ3["🎯 THD+N < 0.1%"]
            AQ4["📊 Dynamic Range > 90dB"]
        end
        
        subgraph "System Performance"
            SP1["💻 CPU < 10%"]
            SP2["🧠 RAM < 500MB"]
            SP3["🎵 Real-time 48kHz"]
            SP4["⏱️ Stable Operation > 1hr"]
        end
        
        subgraph "Accuracy"
            AC1["🎛️ Calibration ±2dB"]
            AC2["🎼 Frequency ±1Hz"]
            AC3["⏲️ Time ±0.1ms"]
            AC4["🔄 Phase ±5°"]
        end
    end
    
    style AQ1 fill:#e8f5e8
    style AQ2 fill:#e8f5e8
    style AQ3 fill:#e8f5e8
    style AQ4 fill:#e8f5e8
    style SP1 fill:#e3f2fd
    style SP2 fill:#e3f2fd
    style SP3 fill:#e3f2fd
    style SP4 fill:#e3f2fd
    style AC1 fill:#fff3e0
    style AC2 fill:#fff3e0
    style AC3 fill:#fff3e0
    style AC4 fill:#fff3e0
        </div>
    </div>

    <script>
        // Mermaid global init (for static samples)
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' }
        });

        // Harness: fetch, parse, sanitize, render, and run Mermaid
        (function(){
            const RAW_BASE = 'https://raw.githubusercontent.com/wiki/Nyrk0/qualia_nss/';
            const pathInput = document.getElementById('wikiPath');
            const loadBtn = document.getElementById('loadBtn');
            const output = document.getElementById('wikiOutput');
            const statusEl = document.getElementById('status');

            function setStatus(msg, isError){
                statusEl.textContent = msg || '';
                statusEl.style.color = isError ? '#c00' : '#666';
            }

            function processMermaidBlocks(html){
                const regex = /<pre><code class=\"language-mermaid\">([\s\S]*?)<\/code><\/pre>/gi;
                return html.replace(regex, (match, code) => {
                    // Keep as-is; Marked already escaped; DOMPurify will have run
                    return `<div class="mermaid">${code}</div>`;
                });
            }

            function rewriteRelativeLinks(container){
                const WIKI_PAGE_BASE = 'https://github.com/Nyrk0/qualia_nss/wiki/';
                const WIKI_RAW_BASE = RAW_BASE; // for images if needed
                // Update anchor hrefs
                container.querySelectorAll('a[href]').forEach(a => {
                    const href = a.getAttribute('href');
                    if (!href) return;
                    if (/^(https?:)?\/\//i.test(href)) return; // absolute
                    if (href.startsWith('#')) return; // in-page
                    // Route to GitHub wiki page for simplicity in harness
                    a.setAttribute('href', WIKI_PAGE_BASE + href.replace(/\.md$/, ''));
                    a.setAttribute('target', '_blank');
                    a.setAttribute('rel', 'noopener noreferrer');
                });
                // Update image srcs
                container.querySelectorAll('img[src]').forEach(img => {
                    const src = img.getAttribute('src');
                    if (!src) return;
                    if (/^(https?:)?\/\//i.test(src)) return; // absolute
                    img.setAttribute('src', WIKI_RAW_BASE + src.replace(/^\.?\/?/, ''));
                });
            }

            async function loadWiki(){
                try {
                    const path = (pathInput.value || 'Home.md').replace(/^\/?/, '');
                    setStatus(`Fetching ${path} ...`);
                    output.innerHTML = '<div style="padding:8px; color:#666;">Loading...</div>';
                    const res = await fetch(RAW_BASE + path);
                    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
                    const md = await res.text();

                    if (!window.marked) throw new Error('Marked.js not loaded');
                    if (!window.DOMPurify) throw new Error('DOMPurify not loaded');

                    let html = window.marked.parse(md);
                    html = processMermaidBlocks(html);
                    const safe = window.DOMPurify.sanitize(html, { ADD_ATTR: ['target','rel'] });
                    output.innerHTML = `<div class="wiki-content">${safe}</div>`;

                    // Fix links/images to absolute
                    rewriteRelativeLinks(output);

                    // Render Mermaid blocks
                    try {
                        if (typeof mermaid !== 'undefined') {
                            mermaid.init(undefined, output.querySelectorAll('.mermaid'));
                        }
                    } catch (e) {
                        console.error('Mermaid rendering error:', e);
                    }
                    setStatus(`Loaded ${path}`);
                } catch (err) {
                    console.error(err);
                    setStatus(err.message || 'Failed to load', true);
                    output.innerHTML = `<div style="color:#c00;">Error: ${ (err && err.message) || err }</div>`;
                }
            }

            loadBtn?.addEventListener('click', (e) => { e.preventDefault(); loadWiki(); });
            // Auto-load default on page open
            document.addEventListener('DOMContentLoaded', () => { loadWiki(); });
        })();
    </script>

    <footer style="margin-top: 50px; text-align: center; color: #666;">
        <p>🧜‍♀️ Powered by Mermaid.js | Qualia-NSS Phase 4 Architecture</p>
    </footer>
</body>
</html>