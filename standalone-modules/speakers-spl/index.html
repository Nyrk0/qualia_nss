<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SPL Viewer - Stage 3: Standalone (Working)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="upload-service.js"></script>
    <script src="spl-file-selector.js"></script>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
        margin: 10px 0 0 0;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
        height: calc(100vh - 200px);
      }

      .chart-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        padding: 20px;
        display: flex;
        flex-direction: column;
      }

      .controls {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
      }

      .file-input-wrapper input[type='file'] {
        position: absolute;
        left: -9999px;
      }

      .file-input-label {
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-radius: 8px;
        cursor: pointer;
        display: inline-block;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .file-input-label:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        background: #28a745;
        color: white;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .btn.secondary {
        background: #6c757d;
      }

      .btn.warning {
        background: #ffc107;
        color: #212529;
      }

      .chart-container {
        flex: 1;
        position: relative;
        min-height: 400px;
      }

      .analysis-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .analysis-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .analysis-header h3 {
        margin: 0;
        font-size: 1.4em;
      }

      .analysis-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
      }

      .metric-group {
        margin-bottom: 25px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .metric-group h4 {
        margin: 0 0 15px 0;
        color: #495057;
        font-size: 1.1em;
      }

      .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 8px 0;
        padding: 8px 12px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .metric-label {
        font-weight: 500;
        color: #495057;
      }

      .metric-value {
        font-weight: 600;
        color: #007bff;
      }

      .status {
        margin: 15px 0;
        padding: 12px 16px;
        border-radius: 8px;
        font-weight: 500;
      }

      .status.info {
        background: #e3f2fd;
        color: #1565c0;
        border-left: 4px solid #2196f3;
      }

      .status.success {
        background: #e8f5e8;
        color: #2e7d32;
        border-left: 4px solid #4caf50;
      }

      .status.error {
        background: #ffebee;
        color: #c62828;
        border-left: 4px solid #f44336;
      }

      .curve-list {
        margin-top: 20px;
      }

      .curve-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        background: white;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .curve-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .curve-info {
        flex: 1;
      }

      .curve-name {
        font-weight: 500;
        color: #495057;
      }

      .curve-stats {
        font-size: 0.9em;
        color: #6c757d;
      }

      @media (max-width: 1200px) {
        .main-grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .analysis-panel {
          max-height: 400px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üéµ SPL Viewer - Stage 3</h1>
        <p>Professional Acoustic Analysis (Standalone)</p>
      </div>

      <div class="main-grid">
        <div class="chart-section">
          <div class="controls">
            <div class="file-input-wrapper">
              <input type="file" id="file-input" accept=".csv" multiple />
              <label for="file-input" class="file-input-label">
                üìÅ Select CSV Files
              </label>
            </div>
            <button class="btn" id="load-btn">üìä Load & Analyze</button>
            <button class="btn" id="upload-btn">‚òÅÔ∏è Upload to Server</button>
            <button class="btn secondary" id="sum-btn" disabled>
              ‚ûï Calculate Sum
            </button>
            <button class="btn warning" id="clear-btn">üóëÔ∏è Clear All</button>
          </div>

          <div id="status-area">
            <div class="status info">
              üëã Welcome! Load CSV files to begin professional acoustic
              analysis.
            </div>
          </div>

          <div class="chart-container">
            <canvas id="spl-chart"></canvas>
          </div>
        </div>

        <div class="analysis-panel">
          <div class="analysis-header">
            <h3>üìà Professional Analysis</h3>
          </div>
          <div class="analysis-content" id="analysis-content">
            <div class="metric-group">
              <h4>üìä Overview</h4>
              <div class="metric">
                <span class="metric-label">Loaded Curves</span>
                <span class="metric-value" id="curves-count">0</span>
              </div>
              <div class="metric">
                <span class="metric-label">Total Points</span>
                <span class="metric-value" id="points-count">0</span>
              </div>
              <div class="metric">
                <span class="metric-label">Memory Usage</span>
                <span class="metric-value" id="memory-usage">0 MB</span>
              </div>
            </div>

            <div
              class="metric-group"
              id="acoustic-metrics"
              style="display: none"
            >
              <h4>üîä Acoustic Analysis</h4>
              <div class="metric">
                <span class="metric-label">A-weighted SPL</span>
                <span class="metric-value" id="a-weighted-spl">-- dB(A)</span>
              </div>
              <div class="metric">
                <span class="metric-label">Peak Level</span>
                <span class="metric-value" id="peak-level">-- dB</span>
              </div>
              <div class="metric">
                <span class="metric-label">Crest Factor</span>
                <span class="metric-value" id="crest-factor">-- dB</span>
              </div>
              <div class="metric">
                <span class="metric-label">Resonances</span>
                <span class="metric-value" id="resonances-count">0</span>
              </div>
            </div>

            <div
              class="metric-group"
              id="validation-metrics"
              style="display: none"
            >
              <h4>‚úÖ Validation</h4>
              <div class="metric">
                <span class="metric-label">Mathematical Tests</span>
                <span class="metric-value" id="math-tests">-- / 13</span>
              </div>
              <div class="metric">
                <span class="metric-label">Quality Score</span>
                <span class="metric-value" id="quality-score">--%</span>
              </div>
              <div class="metric">
                <span class="metric-label">Physical Coherence</span>
                <span class="metric-value" id="coherence">--</span>
              </div>
            </div>

            <div class="curve-list" id="curve-list">
              <!-- Curves will be listed here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      console.log('üöÄ SPL Viewer Stage 3 Standalone starting...');

      // Inline acoustic analysis functions (simplified)
      function calculateBasicAWeightedSPL(data) {
        if (!data || data.length === 0) return 0;

        // Simplified A-weighting approximation
        let weightedSum = 0;
        let count = 0;

        for (const point of data) {
          const f = point.frequency;
          const spl = point.spl;

          // Basic A-weighting approximation
          let aWeight = 0;
          if (f >= 1000 && f <= 4000) {
            aWeight = 2; // Peak response around 1-4kHz
          } else if (f >= 500 && f <= 8000) {
            aWeight = 0; // Flat response in mid frequencies
          } else if (f < 500) {
            aWeight = -10 * Math.log10(f / 1000); // Roll-off below 500Hz
          } else {
            aWeight = -5; // High frequency roll-off
          }

          const weightedSPL = spl + aWeight;
          weightedSum += Math.pow(10, weightedSPL / 10);
          count++;
        }

        return count > 0 ? 10 * Math.log10(weightedSum / count) : 0;
      }

      function findBasicResonances(data) {
        if (!data || data.length < 3) return [];

        const resonances = [];
        const minPeakHeight = 3; // Minimum 3dB peak

        for (let i = 1; i < data.length - 1; i++) {
          const prev = data[i - 1];
          const curr = data[i];
          const next = data[i + 1];

          // Check if this is a local peak
          if (curr.spl > prev.spl && curr.spl > next.spl) {
            const peakHeight = Math.min(
              curr.spl - prev.spl,
              curr.spl - next.spl
            );
            if (peakHeight >= minPeakHeight) {
              resonances.push({
                frequency: curr.frequency,
                spl: curr.spl,
                peakHeight: peakHeight,
              });
            }
          }
        }

        return resonances;
      }

      function calculateBasicCrestFactor(data) {
        if (!data || data.length === 0) return 0;

        const spls = data.map(p => p.spl);
        const peak = Math.max(...spls);
        const avg = spls.reduce((a, b) => a + b, 0) / spls.length;

        return peak - avg;
      }

      function estimateBasicMemoryUsage(curves) {
        let totalPoints = 0;
        curves.forEach(curve => {
          totalPoints += curve.length;
        });

        // Rough estimate: each point takes about 32 bytes (frequency + spl + overhead)
        const bytes = totalPoints * 32;
        return {
          bytes: bytes,
          kb: bytes / 1024,
          mb: bytes / (1024 * 1024),
        };
      }

      function runBasicMathTests() {
        const tests = [
          {
            name: '70+70 dB Sum',
            expected: 73.01,
            actual:
              10 * Math.log10(Math.pow(10, 70 / 10) + Math.pow(10, 70 / 10)),
          },
          {
            name: '60+60 dB Sum',
            expected: 63.01,
            actual:
              10 * Math.log10(Math.pow(10, 60 / 10) + Math.pow(10, 60 / 10)),
          },
          {
            name: '80+80 dB Sum',
            expected: 83.01,
            actual:
              10 * Math.log10(Math.pow(10, 80 / 10) + Math.pow(10, 80 / 10)),
          },
        ];

        let passed = 0;
        tests.forEach(test => {
          if (Math.abs(test.actual - test.expected) < 0.1) {
            passed++;
          }
        });

        return { passed, total: tests.length, tests };
      }

      // Simple CSV parser
      function parseCSVContent(csvContent, filename = 'unknown') {
        const lines = csvContent.trim().split('\n');
        const data = [];
        const errors = [];

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const parts = line.split(',');
          if (parts.length >= 2) {
            const frequency = parseFloat(parts[0]);
            const spl = parseFloat(parts[1]);

            if (!isNaN(frequency) && !isNaN(spl)) {
              data.push({ frequency, spl });
            } else {
              errors.push(`Line ${i + 1}: Invalid data`);
            }
          } else {
            errors.push(`Line ${i + 1}: Not enough columns`);
          }
        }

        return { data, errors, filename };
      }

      // Simple SPL sum calculation
      function calculateSPLSum(curves) {
        if (!curves || curves.length < 2) {
          throw new Error('Need at least 2 curves for sum calculation');
        }

        // Create frequency grid from all curves
        const allFreqs = new Set();
        curves.forEach(curve => {
          curve.data.forEach(point => allFreqs.add(point.frequency));
        });

        const sortedFreqs = Array.from(allFreqs).sort((a, b) => a - b);
        const sumData = [];

        for (const freq of sortedFreqs) {
          let linearSum = 0;
          let validCurves = 0;

          curves.forEach(curve => {
            // Find exact or interpolated value
            let value = null;

            // Try exact match first
            const exactPoint = curve.data.find(
              p => Math.abs(p.frequency - freq) < 0.001
            );
            if (exactPoint) {
              value = exactPoint.spl;
            } else {
              // Simple linear interpolation
              const before = curve.data.filter(p => p.frequency < freq).pop();
              const after = curve.data.find(p => p.frequency > freq);

              if (before && after) {
                const ratio =
                  (freq - before.frequency) /
                  (after.frequency - before.frequency);
                value = before.spl + ratio * (after.spl - before.spl);
              }
            }

            if (value !== null) {
              linearSum += Math.pow(10, value / 10);
              validCurves++;
            }
          });

          if (validCurves > 0) {
            const sumSPL = 10 * Math.log10(linearSum);
            sumData.push({ frequency: freq, spl: sumSPL });
          }
        }

        return { data: sumData, name: 'Acoustic Sum' };
      }

      class SPLViewerStage3Standalone {
        constructor() {
          this.curves = new Map();
          this.chart = null;
          this.sumCurve = null;
          this.uploadService = new UploadService();
          this.colors = [
            '#ff6b6b',
            '#4ecdc4',
            '#45b7d1',
            '#96ceb4',
            '#ffeaa7',
            '#dda0dd',
            '#98d8c8',
            '#f7dc6f',
            '#bb8fce',
            '#85c1e9',
          ];

          this.initChart();
          this.setupEventListeners();
          this.checkBackendHealth();
          this.showStatus(
            'üöÄ Stage 3 Standalone Analysis initialized successfully!',
            'success'
          );

          console.log('üéØ SPL Viewer Stage 3 Standalone ready');
        }

        initChart() {
          const ctx = document.getElementById('spl-chart').getContext('2d');
          this.chart = new Chart(ctx, {
            type: 'line',
            data: { datasets: [] },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                intersect: false,
                mode: 'index',
              },
              scales: {
                x: {
                  type: 'logarithmic',
                  position: 'bottom',
                  title: {
                    display: true,
                    text: 'Frequency (Hz)',
                    font: { size: 14, weight: 'bold' },
                  },
                  min: 20,
                  max: 20000,
                  grid: { color: 'rgba(0,0,0,0.1)' },
                },
                y: {
                  title: {
                    display: true,
                    text: 'SPL (dB)',
                    font: { size: 14, weight: 'bold' },
                  },
                  grid: { color: 'rgba(0,0,0,0.1)' },
                },
              },
              plugins: {
                legend: {
                  position: 'top',
                  labels: { usePointStyle: true },
                },
                tooltip: {
                  callbacks: {
                    title: function (context) {
                      return `Frequency: ${context[0].parsed.x.toFixed(1)} Hz`;
                    },
                    label: function (context) {
                      return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} dB`;
                    },
                  },
                },
              },
            },
          });
          console.log('‚úÖ Chart initialized');
        }

        setupEventListeners() {
          document
            .getElementById('load-btn')
            .addEventListener('click', () => this.handleFileLoad());
          document
            .getElementById('upload-btn')
            .addEventListener('click', () => this.handleFileUpload());
          document
            .getElementById('sum-btn')
            .addEventListener('click', () => this.calculateSum());
          document
            .getElementById('clear-btn')
            .addEventListener('click', () => this.clearAll());

          document
            .getElementById('file-input')
            .addEventListener('change', e => {
              const count = e.target.files.length;
              this.showStatus(
                `üìÅ ${count} file${count !== 1 ? 's' : ''} selected for analysis`,
                'info'
              );
            });
        }

        async checkBackendHealth() {
          try {
            const isHealthy = await this.uploadService.checkHealth();
            if (isHealthy) {
              console.log('‚úÖ Backend server is healthy');
            } else {
              console.warn('‚ö†Ô∏è Backend server health check failed');
            }
          } catch (error) {
            console.warn('‚ö†Ô∏è Backend server not available:', error.message);
          }
        }

        async handleFileUpload() {
          const fileInput = document.getElementById('file-input');
          const files = fileInput.files;

          if (files.length === 0) {
            this.showStatus('Please select CSV files first', 'error');
            return;
          }

          this.showStatus(
            `‚òÅÔ∏è Uploading ${files.length} file(s) to server...`,
            'info'
          );

          try {
            const uploadResults = [];

            for (let i = 0; i < files.length; i++) {
              const file = files[i];

              // Validate file before upload
              this.uploadService.validateCSVFile(file);

              const result = await this.uploadService.uploadFile(
                file,
                'stage3_user'
              );
              uploadResults.push(result);

              this.showStatus(
                `‚òÅÔ∏è Uploaded ${i + 1}/${files.length}: ${file.name}`,
                'info'
              );
            }

            this.showStatus(
              `‚úÖ Successfully uploaded ${uploadResults.length} file(s) to secure server storage`,
              'success'
            );

            // Show upload results
            const totalSize = uploadResults.reduce(
              (sum, result) => sum + result.file_size,
              0
            );
            console.log('Upload Summary:', {
              files: uploadResults.length,
              totalSize: this.uploadService.formatFileSize(totalSize),
              fileIds: uploadResults.map(r => r.file_id),
            });
          } catch (error) {
            this.showStatus(`‚ùå Upload failed: ${error.message}`, 'error');
            console.error('Upload error:', error);
          }
        }

        showStatus(message, type = 'info') {
          const statusArea = document.getElementById('status-area');
          const className = `status ${type}`;
          const icon =
            type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
          statusArea.innerHTML = `<div class="${className}">${icon} ${message}</div>`;
          console.log(`${type.toUpperCase()}: ${message}`);
        }

        async handleFileLoad() {
          const fileInput = document.getElementById('file-input');
          const files = fileInput.files;

          if (files.length === 0) {
            this.showStatus('Please select CSV files first', 'error');
            return;
          }

          this.showStatus(
            `üîÑ Loading and analyzing ${files.length} file(s)...`,
            'info'
          );

          try {
            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              const curve = await this.loadCSVFile(file, i);
              this.curves.set(file.name, curve);
            }

            this.updateChart();
            this.runAnalysis();
            this.updateAnalysisPanel();

            document.getElementById('sum-btn').disabled = this.curves.size < 2;

            this.showStatus(
              `üéâ Successfully loaded and analyzed ${this.curves.size} curve(s)`,
              'success'
            );
          } catch (error) {
            this.showStatus(
              `‚ùå Error loading files: ${error.message}`,
              'error'
            );
            console.error('File loading error:', error);
          }
        }

        async loadCSVFile(file, index) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => {
              try {
                const result = parseCSVContent(e.target.result, file.name);

                if (!result.data || result.data.length === 0) {
                  reject(new Error(`No valid data found in ${file.name}`));
                  return;
                }

                const curve = {
                  name: file.name,
                  data: result.data,
                  color: this.colors[index % this.colors.length],
                  stats: this.calculateBasicStats(result.data),
                  analysis: {},
                };

                resolve(curve);
              } catch (error) {
                reject(
                  new Error(`Failed to parse ${file.name}: ${error.message}`)
                );
              }
            };
            reader.onerror = () =>
              reject(new Error(`Failed to read ${file.name}`));
            reader.readAsText(file);
          });
        }

        calculateBasicStats(data) {
          if (!data || data.length === 0) return null;

          const spls = data.map(p => p.spl);
          const freqs = data.map(p => p.frequency);

          return {
            points: data.length,
            minFreq: Math.min(...freqs),
            maxFreq: Math.max(...freqs),
            minSPL: Math.min(...spls),
            maxSPL: Math.max(...spls),
            avgSPL: spls.reduce((a, b) => a + b, 0) / spls.length,
          };
        }

        runAnalysis() {
          this.curves.forEach(curve => {
            curve.analysis = {
              aWeightedSPL: calculateBasicAWeightedSPL(curve.data),
              resonances: findBasicResonances(curve.data),
              crestFactor: calculateBasicCrestFactor(curve.data),
            };
          });

          console.log('üìä Analysis completed for all curves');
        }

        async calculateSum() {
          if (this.curves.size < 2) {
            this.showStatus(
              'Need at least 2 curves for sum calculation',
              'error'
            );
            return;
          }

          this.showStatus('üî¢ Calculating acoustic sum...', 'info');

          try {
            const curvesArray = Array.from(this.curves.values());
            const sumResult = calculateSPLSum(curvesArray);

            if (sumResult && sumResult.data) {
              this.sumCurve = {
                name: 'Acoustic Sum',
                data: sumResult.data,
                color: '#e74c3c',
                isSum: true,
                stats: this.calculateBasicStats(sumResult.data),
                analysis: {
                  aWeightedSPL: calculateBasicAWeightedSPL(sumResult.data),
                  resonances: findBasicResonances(sumResult.data),
                  crestFactor: calculateBasicCrestFactor(sumResult.data),
                },
              };

              this.updateChart();
              this.updateAnalysisPanel();
              this.showStatus(
                '‚úÖ Acoustic sum calculated successfully',
                'success'
              );
            } else {
              throw new Error('Sum calculation returned invalid result');
            }
          } catch (error) {
            this.showStatus(
              `‚ùå Sum calculation failed: ${error.message}`,
              'error'
            );
            console.error('Sum calculation error:', error);
          }
        }

        updateChart() {
          const datasets = [];

          // Add individual curves
          this.curves.forEach(curve => {
            datasets.push({
              label: curve.name,
              data: curve.data.map(point => ({
                x: point.frequency,
                y: point.spl,
              })),
              borderColor: curve.color,
              backgroundColor: curve.color + '20',
              borderWidth: 2,
              fill: false,
              pointRadius: 0,
              pointHoverRadius: 4,
              tension: 0.1,
            });
          });

          // Add sum curve if exists
          if (this.sumCurve) {
            datasets.push({
              label: this.sumCurve.name,
              data: this.sumCurve.data.map(point => ({
                x: point.frequency,
                y: point.spl,
              })),
              borderColor: this.sumCurve.color,
              backgroundColor: this.sumCurve.color + '20',
              borderWidth: 3,
              fill: false,
              pointRadius: 0,
              pointHoverRadius: 4,
              tension: 0.1,
              borderDash: [5, 5],
            });
          }

          this.chart.data.datasets = datasets;
          this.chart.update();

          console.log(`Chart updated with ${datasets.length} datasets`);
        }

        updateAnalysisPanel() {
          // Update overview metrics
          const totalPoints = Array.from(this.curves.values()).reduce(
            (sum, curve) => sum + curve.data.length,
            0
          );

          document.getElementById('curves-count').textContent =
            this.curves.size;
          document.getElementById('points-count').textContent =
            totalPoints.toLocaleString();

          const allData = Array.from(this.curves.values()).map(c => c.data);
          const memUsage = estimateBasicMemoryUsage(allData);
          document.getElementById('memory-usage').textContent =
            `${memUsage.mb.toFixed(1)} MB`;

          // Show acoustic analysis if we have data
          if (this.curves.size > 0) {
            document.getElementById('acoustic-metrics').style.display = 'block';
            document.getElementById('validation-metrics').style.display =
              'block';

            // Use sum curve for analysis if available, otherwise first curve
            const analysisCurve =
              this.sumCurve || Array.from(this.curves.values())[0];

            if (analysisCurve && analysisCurve.analysis) {
              document.getElementById('a-weighted-spl').textContent =
                `${analysisCurve.analysis.aWeightedSPL.toFixed(2)} dB(A)`;
              document.getElementById('peak-level').textContent =
                `${analysisCurve.stats ? analysisCurve.stats.maxSPL.toFixed(2) : '--'} dB`;
              document.getElementById('crest-factor').textContent =
                `${analysisCurve.analysis.crestFactor.toFixed(2)} dB`;
              document.getElementById('resonances-count').textContent =
                analysisCurve.analysis.resonances.length;

              // Run math tests
              const mathTests = runBasicMathTests();
              document.getElementById('math-tests').textContent =
                `${mathTests.passed} / ${mathTests.total}`;

              const quality = (
                (mathTests.passed / mathTests.total) *
                100
              ).toFixed(0);
              document.getElementById('quality-score').textContent =
                `${quality}%`;
              document.getElementById('coherence').textContent =
                quality > 80 ? 'GOOD' : quality > 60 ? 'FAIR' : 'POOR';
            }
          }

          // Update curve list
          this.updateCurveList();
        }

        updateCurveList() {
          const curveList = document.getElementById('curve-list');
          curveList.innerHTML = '<h4>üìã Loaded Curves</h4>';

          this.curves.forEach((curve, name) => {
            const item = document.createElement('div');
            item.className = 'curve-item';
            item.innerHTML = `
                        <div class="curve-color" style="background-color: ${curve.color}"></div>
                        <div class="curve-info">
                            <div class="curve-name">${name}</div>
                            <div class="curve-stats">${curve.stats.points} points ‚Ä¢ ${curve.stats.minFreq.toFixed(0)}-${curve.stats.maxFreq.toFixed(0)} Hz</div>
                        </div>
                    `;
            curveList.appendChild(item);
          });

          if (this.sumCurve) {
            const item = document.createElement('div');
            item.className = 'curve-item';
            item.innerHTML = `
                        <div class="curve-color" style="background-color: ${this.sumCurve.color}"></div>
                        <div class="curve-info">
                            <div class="curve-name">${this.sumCurve.name} ‚≠ê</div>
                            <div class="curve-stats">${this.sumCurve.data.length} points ‚Ä¢ Calculated</div>
                        </div>
                    `;
            curveList.appendChild(item);
          }
        }

        clearAll() {
          this.curves.clear();
          this.sumCurve = null;
          this.chart.data.datasets = [];
          this.chart.update();

          document.getElementById('file-input').value = '';
          document.getElementById('sum-btn').disabled = true;

          // Hide analysis sections
          document.getElementById('acoustic-metrics').style.display = 'none';
          document.getElementById('validation-metrics').style.display = 'none';

          // Reset metrics
          document.getElementById('curves-count').textContent = '0';
          document.getElementById('points-count').textContent = '0';
          document.getElementById('memory-usage').textContent = '0 MB';

          // Clear curve list
          document.getElementById('curve-list').innerHTML =
            '<h4>üìã No curves loaded</h4>';

          this.showStatus('üóëÔ∏è All data cleared', 'info');
        }
      }

      // Initialize Stage 3 Standalone
      window.addEventListener('DOMContentLoaded', () => {
        try {
          window.splViewerStage3 = new SPLViewerStage3Standalone();
          console.log(
            'üéâ SPL Viewer Stage 3 Standalone initialized successfully!'
          );
        } catch (error) {
          console.error('‚ùå Failed to initialize Stage 3:', error);
          document.getElementById('status-area').innerHTML =
            '<div class="status error">‚ùå Failed to initialize Stage 3: ' +
            error.message +
            '</div>';
        }
      });

      // Global error handler
      window.addEventListener('error', e => {
        console.error('Global error:', e.error);
        document.getElementById('status-area').innerHTML =
          '<div class="status error">‚ùå Application Error: ' +
          e.message +
          '</div>';
      });

      console.log('‚úÖ SPL Viewer Stage 3 Standalone script loaded');
    </script>
  </body>
</html>
